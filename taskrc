# taskrc for tox-py
# vim: filetype=sh :

#  Use taskrc -h for help on built-in taskrc functions.
#  To provide help for definitions in this file, add #Help tags, e.g.:
#    function my_func {
     #Help: my_func is my first and only function...

Python=$(which python3.8 || which python3.7 || which python3.6 )

unset _to_debug to_debug to_debugz _to_debugz to_run _to_run TOXHOME ToxPython

ToxHome=${taskrc_dir}
TOXHOME=${ToxHome}
PDB=${PDB:-pudb}
#Help

source ${ToxHome}/tox-completion.bash

red() {
    echo -en "\033[;31m$@\033[;0m"
}
green() {
    echo -en "\033[;32m$@\033[;0m"
}
yellow() {
    echo -en "\033[;33m$@\033[;0m"
}


function docker_build {
    #Help build the Docker image for tox-dev
    cd $taskrc_dir
    docker-compose build --pull || return
    echo "Build complete, run 'container_prepare' to setup for dev ops"
}

function container_prepare {
    #Help after docker_build(), use container_prepare() to setup for dev ops
    (
        cd $taskrc_dir || die 1
        [[ -f /.dockerenv ]] && die "This should not run in a container"
        docker-compose up -d tox-testenv || die "Failed to start tox-testenv container"
        # Setup 'home.$USER' to clone user env stuff into container:
        mkdir -p home.${USER}
        (
            cd home.${USER} || die 101
            cp $HOME/.bashrc . || die 102
            cp $HOME/.inputrc . || die 103
            rsync -av $HOME/.vim . || die 104
            cp $HOME/.gitconfig . || die 105
            rsync -av $HOME/.ssh . || die 106
        ) || die
        echo "home.${USER}" > current_user_home
        docker-compose exec tox-testenv /app/container_prepare_inner.sh || die 3


        green "container_prepare(): Ok"
    )
}

function inner_shell() {
    ( cd $taskrc_dir && docker-compose exec --user $USER tox-testenv bash )
}

function _to_debug {
    $Python -m $PDB ${ToxHome}/tox_core.py "$@"
    set +f;
}

alias to_debug='set -f; _to_debug'
    #Help


function _to_run {
    $Python ${ToxHome}/tox_core.py "$@"
    set +f;
}


function to_test_debug {
    #Help
    $Python -m $PDB ${ToxHome}/test_tox.py "$@"
}

alias to_run='set -f; _to_run'
    #Help


